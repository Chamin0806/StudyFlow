<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>PDF 파일 업로드</title>
</head>
<body>
<h1>PDF 파일 업로드_1</h1>

<form action="/upload" method="post" enctype="multipart/form-data">
    <input type="file" name="file" accept="application/pdf" required><br><br>
    시작 페이지: <input type="number" name="startPage" min="1" required><br><br>
    끝 페이지: <input type="number" name="endPage" min="1" required><br><br>
    <button type="submit">업로드 및 분석 시작</button>
</form>

<div th:if="${taskId}">
    <h2>진행 상황</h2>
    <div id="progressText">분석 시작 대기 중...</div>
</div>

<script>
    const taskId = "[[${taskId}]]";

    console.log("taskId:", taskId);
    if(taskId && taskId.trim() !== ""){
        const intervalId = setInterval(() => {
            fetch(`http://14.46.29.200:3500/progress?task_id=${taskId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.current_page !== undefined && data.total_pages !== undefined) {
                        document.getElementById('progressText').innerText =
                            `현재 ${data.current_page}/${data.total_pages} 페이지 작업 중...`;

                        if (data.current_page === data.total_pages) {
                            clearInterval(intervalId);
                            document.getElementById('progressText').innerText = "분석 완료!";

                            // ✅ 분석 끝나면 결과 가져오기
                            fetch(`http://14.46.29.200:3500/result?task_id=${taskId}`)
                                .then(response => response.json())
                                .then(resultData => {
                                    console.log("최종 요약 결과:", resultData);

                                    // 결과를 웹에 표시
                                    const resultDiv = document.createElement("div");
                                    resultDiv.innerHTML = "<h3>요약 결과</h3><pre>" + JSON.stringify(resultData, null, 2) + "</pre>";
                                    document.body.appendChild(resultDiv);
                                })
                                .catch(error => {
                                    console.error("요약 결과 요청 오류:", error);
                                });
                        }
                    }
                })
                .catch(error => {
                    console.error("Progress 요청 중 오류:", error);
                });
        }, 2000);
    }

</script>

</body>
</html>
